---
layout: post
title: 爬取国家外汇管理局的外汇数据
date: 2022-05-31
author: LiuJing
categories:
  - 数据分析部
tags:
  - selenium 

---
# 爬取国家外汇管理局的外汇数据

## 安装Selenium库以及下载浏览器补丁

### Selenium安装

直接使用   Pip install selenium 安装

### 下载浏览器补丁

chromedriver下载地址：
1. https://sites.google.com/a/chromium.org/chromedriver/downloads （被墙了）
2. https://chromedriver.storage.googleapis.com/index.html（可用）
3. http://npm.taobao.org/mirrors/chromedriver/（可用）

>注意 ：chromedriver的版本要与你使用的chrome版本对应

下载驱动，然后将驱动文件路径配置在环境变量即可


## 导入相关库

```python
from selenium import webdriver
import datetime
from dateutil.relativedelta import relativedelta
from selenium.webdriver.common.by import By
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC
```

## 连接网页

需要指定Chrome启动文件，即指定chromedriver的位置

```python
option = webdriver.ChromeOptions()
option.binary_location = 'C:\\Users\\ASUS\\AppData\\Local\\Chromium\\Application\\Chromium.exe'	# binary_location属性指定Chrome启动文件
option.add_argument('headless')		# add_argument属性指定浏览器开启隐式

driver = webdriver.Chrome(r'C:\ProgramData\Anaconda3\chromedriver.exe', options=option)
driver.set_window_size(1800,900)	# 浏览器窗口大小
driver.get('https://www.safe.gov.cn/safe/rmbhlzjj/index.html')
```

## webdriver爬虫#document问题

```python
driver.switch_to.default_content()
frame = driver.find_elements_by_tag_name('iframe')[0]  
driver.switch_to.frame(frame)
```

## 获取今天的日期以及一年前的今天的日期

```python
nowDate = datetime.date.today().strftime('%Y-%m-%d')
forwordDate = (datetime.datetime.now()- relativedelta(years=1)).strftime('%Y-%m-%d')
```

## 输入搜索内容

```python
driver.find_element(By.CSS_SELECTOR,'#startDateId').send_keys(forwordDate)
driver.find_element(By.CSS_SELECTOR,'#endDateId').send_keys(nowDate)
driver.save_screenshot('baidu.png')
```
## 点击查询

```python
wait = WebDriverWait(driver, 10)
confirm_btn=wait.until(EC.element_to_be_clickable((By.CSS_SELECTOR,'#RMBQuery > table > tbody > tr:nth-child(2) > td > table > tbody > tr > td > table > tbody > tr > td:nth-child(2) > span.form-table-label > input[type=button]')))      
confirm_btn.click()
```

## 存储数据

```python
dollar=[] #美元
euro=[] #欧元
yen=[] #日元
publishTime=[] #时间

rowCount = len(driver.find_elements(By.XPATH,'//*[@id="InfoTable"]/tbody/tr'))
for i in range(2,rowCount+1):
    dollar.append(driver.find_element_by_xpath('//*[@id="InfoTable"]/tbody/tr[%s]/td[2]'%(i)).text)
    euro.append(driver.find_element_by_xpath('//*[@id="InfoTable"]/tbody/tr[%s]/td[3]'%(i)).text)
    yen.append(driver.find_element_by_xpath('//*[@id="InfoTable"]/tbody/tr[%s]/td[2]'%(i)).text)
    publishTime.append(driver.find_element_by_xpath('//*[@id="InfoTable"]/tbody/tr[%s]/td[1]'%(i)).text)
```